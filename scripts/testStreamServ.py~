import socket, time  
import sys
import socket, time, Image, StringIO  
import cv2.cv as cv  

mySock = 0
srcSock = 0
dstSock = 0

def startServer():
    global mySock
    global srcSock
    global dstSock
    mySock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)  
    SOCKNUM = 2
    HOST = "0.0.0.0"
    PORT = 9119
    mySock.bind((HOST, PORT))  
    mySock.listen(SOCKNUM)  
    print "Start Server!"
    srcSock, src_addr = mySock.accept()  
    print "Source Connected by", src_addr  
      
    #dstSock, dst_addr = mySock.accept()  
    #print "Destination Connected by", dst_addr
    return 0

def closeServer():
    global mySock
    global srcSock
    global dstSock
    srcSock.close()  
    mySock.close()  
    #dstSock.close()
    return 0

def transferData():
    global mySock
    global srcSock
    global dstSock
    msg = srcSock.recv(1024 * 1024)  
    print len(msg)  
    if not msg:  
        return -1  
    try:  
        dstSock.sendall(msg)  
    except Exception as ex:  
        #dst, dst_addr = sock.accept()  
        #print "Destination Connected Again By", dst_addr  
        print "Destination connection broken"
        return -1
    except KeyboardInterrupt:  
        print "Interrupted!"  
        return -1
    return 0  
def readData():
    global mySock
    global srcSock
    global dstSock
    msg = srcSock.recv(1024 * 1024)  
    print len(msg)  
    if not msg:  
        return -1  
    jpeg = msg.replace("\-n", "\n") 

    buf = StringIO.StringIO(jpeg[0:-1])  
    buf.seek(0)  
    pi = Image.open(buf)  
    img = cv.CreateImageHeader((640, 480), cv.IPL_DEPTH_8U, 3)  
    cv.SetData(img, pi.tostring())  
    buf.close()  

    #cv.ShowImage("camera_Detect", img)  
    return img



if __name__ == "__main__":
    
    if len(sys.argv) != 1:
        print("Usage: python testStreamServ.py ")
        exit(-1)
    startServer()    
    cv.NamedWindow("camera_Detect")  
    while True:  
        #rst = transferData()
        rst = readData()
        if(rst != 0):
            break;
        if cv.WaitKey(10) == 122:  
            break;
    closeServer()
    cv.DestroyAllWindows()

